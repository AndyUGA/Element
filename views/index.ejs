<!DOCTYPE html>
<html>

<head>
    <% include reusableComponents/css.html %>
        <script type="text/javascript" src="instascan.js"></script>
        <title>Check-In</title>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="/">Check-In</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav mr-auto">

            <li class="nav-item"><a class="nav-link" href="/Element/attendeePoints">Attendee Points</a></li>
            <li class="nav-item"><a class="nav-link" href="/Element/housePoints">House Points</a></li>
            <li class="nav-item"><a class="nav-link" href="/Element/history">History</a></li>
            <li class="nav-item"><a class="nav-link" href="/Element/attendeeInfo"> Attendee Info</a></li>
            <li class="nav-item"><a class="nav-link" href="/Element/workshop"> Workshops </a></li>
          </ul>
        </div>

    </nav>

    <div class="pricing pricing--norbu">
        <div class="pricing__item">
            <br>
            <img class="cardIMG" src="images/uvsase_main_logomark.png" alt="Card image cap">
            <br><br>
            <video width="330" height="250" playsinline controls="true" id="preview"></video>
        </div>
    </div>
    <div class="d-flex justify-content-center">
        <p id="name"> </p>
    </div>
    <div class="d-flex justify-content-center">
        <p id="score"> </p>
    </div>
    <div class="d-flex justify-content-center">
        <p id="workshop"> </p>
    </div>
    <div class="d-flex justify-content-center">
        <p id="check"> </p>
    </div>
    <div class="d-flex justify-content-center">
        <p id="house"> </p>
    </div>






    <script type="text/javascript">
        let scanner = new Instascan.Scanner({
            video: document.getElementById('preview'),
            mirror: false,
            backgroundScan: false,
            scanPeriod: 3,
        });
        scanner.addListener('scan', function(content) {

            let data = JSON.parse(content);

            let matchFound = false;
            let i = 0;
            <% for(i=0; i < result.length; i++) { %>
              //console.log(<%= i %> + " < " + <%= result.length %> );
              //console.log("Comparing <%= result[i].Name %> with " + data['Name'] )
            if ("<%= result[i].Name %>" == data['Name'] && matchFound != true) {
                //console.log("Comparing <%= result[i].Workshop1 %> with " + data['Workshop1'] )
                if ("<%= result[i].Workshop1 %>" == data['Workshop1']) {

                    document.getElementById("name").innerHTML = "Name : " + data['Name'];
                    document.getElementById("score").innerHTML = "Added " + data['Points'] + " points to " + " attendee and " + data['House'];
                    document.getElementById("workshop").innerHTML = "Workshop : " + data['Workshop1'];
                    console.log("Workshops match!");


                    var xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            console.log("/increasePoints request has been sent!");
                        }
                    };

                    xhttp.open("POST", "/increasePoints/" + data['Name'] + "/" + data['Points'] + "/" + data['House'] + "/noRedirect", true);
                    xhttp.send();

                    var xhttp2 = new XMLHttpRequest();
                    xhttp2.onreadystatechange = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            console.log("/workshop request has been sent!");
                        }
                    };

                    xhttp2.open("POST", "/Workshop/" + data['Name'] + "/" + data['Workshop1']);
                    xhttp2.send();

                    return;

                }
            }
            <% } %>



        });

        Instascan.Camera.getCameras().then(function(cameras) {
            if (cameras.length > 0) {
                scanner.start(cameras[0]);
            } else {
                console.error('No cameras found.');
            }
        }).catch(function(e) {
            console.error(e);
        });
    </script>
</body>
</html>
